# Next.js Production Checklist

This document covers Next.js-specific production optimizations and best practices.

## ✅ Performance Optimizations

### Image Optimization
- [x] **Using `next/font`** for font optimization (DM Sans, JetBrains Mono)
- [ ] **Image component**: Use `next/image` when adding images (not yet needed)
- [x] **Image formats**: Configured AVIF and WebP in `next.config.ts`

### Code Splitting
- [x] **Automatic code splitting**: Enabled by Next.js App Router
- [x] **Server Components**: Using Server Components where possible
- [x] **Dynamic imports**: Can be added for heavy components if needed

### Caching
- [x] **Static generation**: Server Components are statically generated by default
- [x] **Image caching**: Configured in `next.config.ts` (60s TTL)

### Bundle Size
- [x] **Tree shaking**: Automatic with Next.js
- [x] **Sentry logger**: Disabled in production (`disableLogger: true`)
- [ ] **Bundle analysis**: Run `npm run build` and review bundle size
  ```bash
  # Install bundle analyzer
  npm install --save-dev @next/bundle-analyzer
  
  # Add to next.config.ts (when needed)
  ```

## ✅ Security

### Headers
- [x] **Security headers**: Configured in `vercel.json`
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: DENY`
  - `X-XSS-Protection: 1; mode=block`
  - `Referrer-Policy: strict-origin-when-cross-origin`
  - `Permissions-Policy: camera=(), microphone=(), geolocation=()`
  - `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload`

### Configuration
- [x] **X-Powered-By**: Disabled (`poweredByHeader: false`)
- [x] **React Strict Mode**: Enabled (`reactStrictMode: true`)
- [x] **HTTPS**: Enforced by Vercel (automatic)

### Environment Variables
- [x] **Only `NEXT_PUBLIC_*` exposed**: Sensitive vars not exposed to client
- [x] **Validation**: `src/lib/config/env.ts` validates required vars
- [x] **Fail fast**: App throws error if required vars missing in production

### Content Security Policy (CSP)
- [ ] **Consider adding CSP**: Can be added to `vercel.json` headers
  ```json
  {
    "key": "Content-Security-Policy",
    "value": "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
  }
  ```
  **Note**: Test thoroughly as CSP can break functionality if too restrictive

## ✅ Correctness

### Type Safety
- [x] **TypeScript**: Full type checking enabled
- [x] **Type checking in CI**: Runs before deployment
- [x] **Strict mode**: TypeScript strict mode enabled

### Error Handling
- [x] **Custom error classes**: Defined in `src/lib/services/errors.ts`
- [x] **Error boundaries**: Consider adding React error boundaries
- [x] **Sentry integration**: Errors tracked automatically

### Testing
- [x] **Unit tests**: Vitest configured (63 tests)
- [x] **E2E tests**: Playwright configured (24 tests)
- [x] **Tests in CI**: Run before deployment

### Build Verification
- [x] **Build script**: Separate for preview/production
- [x] **Build in CI**: Verified before deployment
- [x] **Type checking**: Runs in CI

## ✅ Monitoring

### Error Tracking
- [x] **Sentry**: Configured for client and server
- [x] **Error capture**: Automatic for unhandled errors
- [x] **Custom events**: Money events logged to Sentry

### Performance Monitoring
- [ ] **Sentry Performance**: Consider enabling
- [ ] **Vercel Analytics**: Can be enabled in Vercel dashboard
- [ ] **Web Vitals**: Consider tracking Core Web Vitals

### Logging
- [x] **Structured logging**: Custom logger in `src/lib/utils/logger.ts`
- [x] **Event tracking**: Key money events logged
- [x] **Environment-aware**: Different behavior in dev/prod

## ✅ Build & Deployment

### Build Configuration
- [x] **Environment-specific builds**: `build:preview` and `build:production`
- [x] **Compression**: Enabled (`compress: true`)
- [x] **Source maps**: Uploaded to Sentry (not in client bundle)

### CI/CD
- [x] **GitHub Actions**: Configured for quality checks
- [x] **Automated testing**: Runs on every push/PR
- [x] **Build verification**: Builds before deployment

### Deployment
- [x] **Vercel integration**: Automatic deployments
- [x] **Preview deployments**: For every PR
- [x] **Production deployments**: For `main` branch

## Pre-Production Verification

Before deploying to production:

1. **Run production build locally**:
   ```bash
   npm run build:production
   npm run start
   ```

2. **Test production build**:
   - Verify all pages load
   - Test critical user flows
   - Check for console errors

3. **Verify environment variables**:
   ```bash
   ./scripts/verify-env-vars.sh
   ```

4. **Check bundle size**:
   - Review build output
   - Ensure no unexpected large dependencies

5. **Run Lighthouse audit**:
   - Performance score > 90
   - Accessibility score > 90
   - Best Practices score > 90
   - SEO score > 90

## Post-Deployment Checks

After deploying:

1. **Verify production URL**:
   - Check HTTPS is working
   - Verify environment badge shows "Production"

2. **Test critical flows**:
   - Create month
   - Add income/expense
   - Create goal
   - Link expense to goal

3. **Check monitoring**:
   - Sentry dashboard shows no errors
   - Money events are being logged

4. **Performance check**:
   - Run Lighthouse audit on production
   - Check Vercel Analytics
   - Monitor build times

## Recommended Next Steps

1. **Add React Error Boundary**:
   ```tsx
   // src/components/ErrorBoundary.tsx
   'use client';
   
   import { Component, ReactNode } from 'react';
   import * as Sentry from '@sentry/nextjs';
   
   interface Props {
     children: ReactNode;
   }
   
   interface State {
     hasError: boolean;
   }
   
   export class ErrorBoundary extends Component<Props, State> {
     constructor(props: Props) {
       super(props);
       this.state = { hasError: false };
     }
   
     static getDerivedStateFromError() {
       return { hasError: true };
     }
   
     componentDidCatch(error: Error, errorInfo: any) {
       Sentry.captureException(error, { contexts: { react: errorInfo } });
     }
   
     render() {
       if (this.state.hasError) {
         return (
           <div className="min-h-screen flex items-center justify-center">
             <div className="text-center">
               <h1 className="text-headline text-[var(--color-text)] mb-4">
                 Something went wrong
               </h1>
               <p className="text-body text-[var(--color-text-muted)] mb-6">
                 We've been notified and are working on a fix.
               </p>
               <button
                 onClick={() => window.location.reload()}
                 className="px-4 py-2 bg-[var(--color-primary)] text-white rounded"
               >
                 Reload Page
               </button>
             </div>
           </div>
         );
       }
   
       return this.props.children;
     }
   }
   ```

2. **Enable Vercel Analytics**:
   - Go to Vercel Dashboard → Project → Analytics
   - Enable Web Analytics

3. **Set up Performance Monitoring**:
   - Enable Sentry Performance in `sentry.client.config.ts`
   - Track Core Web Vitals

4. **Add Rate Limiting** (if needed):
   - Consider Vercel Edge Middleware for rate limiting
   - Or use Supabase rate limiting features

## Resources

- [Next.js Production Deployment](https://nextjs.org/docs/deployment)
- [Next.js Security Headers](https://nextjs.org/docs/advanced-features/security-headers)
- [Vercel Security Best Practices](https://vercel.com/docs/security)
- [Sentry Next.js Performance](https://docs.sentry.io/platforms/javascript/guides/nextjs/performance/)

---

**Last Updated**: [Date]
**Status**: ✅ Production Ready / ⚠️ Needs Attention
